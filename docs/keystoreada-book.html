
<h1 id="introduction"><span class="header-section-number">1</span> Introduction</h1>
<p>Ada Keystore is a library and tool to store information in secure wallets and protect the stored information by encrypting the content. It is necessary to know one of the wallet password to access its content. Ada Keystore can be used to safely store passwords, credentials, bank accounts and even documents.</p>
<p>Wallets are protected by a master key using AES-256 and the wallet master key is protected by a user password. The wallet defines up to 7 slots that identify a password key that is able to unlock the master key. To open a wallet, it is necessary to unlock one of these 7 slots by providing the correct password. Wallet key slots are protected by the user’s password and the PBKDF2-HMAC-256 algorithm, a random salt, a random counter and they are encrypted using AES-256.</p>
<p>Values stored in the wallet are protected by their own encryption keys using AES-256. A wallet can contain another wallet which is then protected by its own encryption keys and passwords (with 7 independent slots). Because the child wallet has its own master key, it is necessary to known the primary password and the child password to unlock the parent wallet first and then the child wallet.</p>
<figure>
<img src="images/akt-overview.png" alt="AKT Overview" /><figcaption>AKT Overview</figcaption>
</figure>
<p>The data is organized in 4K blocks whose primary content is encrypted either by the wallet master key or by the entry keys. The data block is signed by using HMAC-256. A data block can contain several values but each of them is protected by its own encryption key. Each value is also signed using HMAC-256.</p>
<p>The keystore uses several encryption keys at different levels to protect the content. A document stored in the keystore is split in data fragment and each data fragment is encrypted by using its own key. The data fragments are stored in specific data blocks so that they are physically separated from the encryption keys.</p>
<p>The data fragment encryption keys are stored in the directory blocks and they are encrypted by using a specific key.</p>
<figure>
<img src="images/akt-keys.png" alt="AKT Keys" /><figcaption>AKT Keys</figcaption>
</figure>
<p>This document describes how to build the tool and library and how you can use the different features to protect your sensitive data.</p>

<h1 id="installation"><span class="header-section-number">2</span> Installation</h1>
<p>This chapter explains how to build and install the library.</p>
<h2 id="before-building"><span class="header-section-number">2.1</span> Before Building</h2>
<p>To build the Ada Keystore you will need the GNAT Ada compiler, either the FSF version available in Debian, FreeBSD systems NetBSD or the AdaCore GNAT Community 2019 edition.</p>
<h3 id="ubuntu"><span class="header-section-number">2.1.1</span> Ubuntu</h3>
<p>Install the following packages:</p>
<pre><code>sudo apt-get install -y make gnat gprbuild git gnupg2</code></pre>
<h3 id="freebsd-12"><span class="header-section-number">2.1.2</span> FreeBSD 12</h3>
<p>Install the following packages:</p>
<pre><code>pkg install gmake gcc6-aux-20180516_1,1 gprbuild-20160609_1 git gnupg-2.2.17_2</code></pre>
<h3 id="windows"><span class="header-section-number">2.1.3</span> Windows</h3>
<p>Get the Ada compiler from <a href="https://www.adacore.com/download">AdaCore Download</a> site and install.</p>
<p>Install the following packages:</p>
<pre><code>pacman -S git
pacman -S make
pacman -S base-devel --needed</code></pre>
<h2 id="getting-the-sources"><span class="header-section-number">2.2</span> Getting the sources</h2>
<p>The project uses a sub-module to help you in the integration and build process. You should checkout the project with the following commands:</p>
<pre><code>   git clone --recursive https://gitlab.com/stcarrez/ada-keystore.git
   cd ada-keystore</code></pre>
<h2 id="configuration"><span class="header-section-number">2.3</span> Configuration</h2>
<p>The library uses the <code>configure</code> script to detect the build environment, check which Ada Utility Library to use. If some component is missing, the <code>configure</code> script will report an error or it will disable the feature. The <code>configure</code> script provides several standard options and you may use:</p>
<ul>
<li><code>--prefix=DIR</code> to control the installation directory,</li>
<li><code>--enable-fuse</code> to enable building the <code>mount</code> command with FUSE,</li>
<li><code>--enable-gtk</code> to enable building the Gtk tool,</li>
<li><code>--enable-shared</code> to enable the build of shared libraries,</li>
<li><code>--disable-static</code> to disable the build of static libraries,</li>
<li><code>--disable-nls</code> to disable NLS support,</li>
<li><code>--with-ada-util=PATH</code> to control the installation path of <a href="https://github.com/stcarrez/ada-util">Ada Utility Library</a>,</li>
<li><code>--with-gtkada=PATH</code> to control the installation path of <a href="https://github.com/AdaCore/GtkAda">Gtk Ada Library</a>,</li>
<li><code>--help</code> to get a detailed list of supported options.</li>
</ul>
<p>In most cases you will configure with the following command:</p>
<pre><code>./configure</code></pre>
<p>The GTK application is not compiled by default unless you configure with the <code>--enable-gtk</code> option. Be sure to install the GtkAda library before configuring and building the project.</p>
<pre><code>./configure  --enable-gtk</code></pre>
<p>On Windows, FreeBSD and NetBSD you have to disable the NLS support:</p>
<pre><code>./configure --disable-nls</code></pre>
<h2 id="build"><span class="header-section-number">2.4</span> Build</h2>
<p>After configuration is successful, you can build the library by running:</p>
<pre><code>make</code></pre>
<p>After building, it is good practice to run the unit tests before installing the library. The unit tests are built and executed using:</p>
<pre><code>make test</code></pre>
<p>And unit tests are executed by running the <code>bin/keystore_harness</code> test program.</p>
<h2 id="installation-1"><span class="header-section-number">2.5</span> Installation</h2>
<p>The installation is done by running the <code>install</code> target:</p>
<pre><code>make install</code></pre>
<p>If you want to install on a specific place, you can change the <code>prefix</code> and indicate the installation direction as follows:</p>
<pre><code>make install prefix=/opt</code></pre>
<h2 id="using"><span class="header-section-number">2.6</span> Using</h2>
<p>To use the library in an Ada project, add the following line at the beginning of your GNAT project file:</p>
<pre><code>with &quot;keystoreada&quot;;</code></pre>

<h1 id="using-ada-keystore-tool"><span class="header-section-number">3</span> Using Ada Keystore Tool</h1>
<p>The <code>akt</code> tool is the command line tool that manages the wallet. It provides the following commands:</p>
<ul>
<li><code>create</code>: create the keystore</li>
<li><code>edit</code>: edit the value with an external editor</li>
<li><code>get</code>: get a value from the keystore</li>
<li><code>help</code>: print some help</li>
<li><code>list</code>: list values of the keystore</li>
<li><code>remove</code>: remove values from the keystore</li>
<li><code>set</code>: insert or update a value in the keystore</li>
</ul>
<p>To create the secure file, use the following command and enter your secure password (it is recommended to use a long and complex password):</p>
<pre><code>   akt create secure.akt</code></pre>
<p>At this step, the secure file is created and it can only be opened by providing the password you entered. To add something, use:</p>
<pre><code>   akt set secure.akt bank.password 012345</code></pre>
<p>To store a file, use the following command:</p>
<pre><code>   akt store secure.akt contract.doc</code></pre>
<p>If you want to retrieve a value, you can use one of:</p>
<pre><code>   akt get secure.akt bank.password
   akt extract secure.akt contract.doc</code></pre>
<p>You can also use the <code>akt</code> command together with the <code>tar</code> command to create secure backups. You can create the compressed tar file, pipe the result to the <code>akt</code> command to store the content in the wallet.</p>
<pre><code>   tar czf - dir-to-backup | akt store secure.akt -- backup.tar.gz</code></pre>
<p>To extract the backup you can use the <code>extract</code> command and feed the result to the <code>tar</code> command as follows:</p>
<pre><code>   akt extract secure.akt -- backup.tar.gz | tar xzf -</code></pre>

<h1 id="programmers-guide"><span class="header-section-number">4</span> Programmer’s Guide</h1>
<h2 id="keystore"><span class="header-section-number">4.1</span> Keystore</h2>
<p>The <code>Keystore</code> package provides operations to store information in secure wallets and protect the stored information by encrypting the content. It is necessary to know one of the wallet password to access its content. Wallets are protected by a master key using AES-256 and the wallet master key is protected by a user password. The wallet defines up to 7 slots that identify a password key that is able to unlock the master key. To open a wallet, it is necessary to unlock one of the 7 slots by providing the correct password. Wallet key slots are protected by the user’s password and the PBKDF2-HMAC-256 algorithm, a random salt, a random counter and they are encrypted using AES-256.</p>
<h3 id="creation"><span class="header-section-number">4.1.1</span> Creation</h3>
<p>To create a keystore you will first declare a <code>Wallet_File</code> instance. You will also need a password that will be used to protect the wallet master key.</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode ada"><code class="sourceCode ada"><a class="sourceLine" id="cb19-1" title="1"><span class="kw">with</span> Keystore.Files;</a>
<a class="sourceLine" id="cb19-2" title="2">...</a>
<a class="sourceLine" id="cb19-3" title="3">  WS   : Keystore.Files.Wallet_File;</a>
<a class="sourceLine" id="cb19-4" title="4">  Pass : Keystore.Secret_Key := Keystore.Create (<span class="st">&quot;There was no choice but to be pioneers&quot;</span>);</a></code></pre></div>
<p>You can then create the keystore file by using the <code>Create</code> operation:</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode ada"><code class="sourceCode ada"><a class="sourceLine" id="cb20-1" title="1">  WS.Create (<span class="st">&quot;secure.akt&quot;</span>, Pass);</a></code></pre></div>
<h3 id="storing"><span class="header-section-number">4.1.2</span> Storing</h3>
<p>Values stored in the wallet are protected by their own encryption keys using AES-256. The encryption key is generated when the value is added to the wallet by using the <code>Add</code> operation.</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode ada"><code class="sourceCode ada"><a class="sourceLine" id="cb21-1" title="1">  WS.Add (<span class="st">&quot;Grace Hopper&quot;</span>, <span class="st">&quot;If it&#39;s a good idea, go ahead and do it.&quot;</span>);</a></code></pre></div>
<p>The <code>Get</code> function allows to retrieve the value. The value is decrypted only when the <code>Get</code> operation is called.</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode ada"><code class="sourceCode ada"><a class="sourceLine" id="cb22-1" title="1">  Citation : <span class="kw">constant</span> <span class="dt">String</span> := WS.Get (<span class="st">&quot;Grace Hopper&quot;</span>);</a></code></pre></div>
<p>The <code>Delete</code> procedure can be used to remove the value. When the value is removed, the encryption key and the data are erased.</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode ada"><code class="sourceCode ada"><a class="sourceLine" id="cb23-1" title="1">  WS.Delete (<span class="st">&quot;Grace Hopper&quot;</span>);</a></code></pre></div>

<h1 id="akt-tool"><span class="header-section-number">5</span> AKT Tool</h1>
<h2 id="name"><span class="header-section-number">5.1</span> NAME</h2>
<p>akt - Tool to protect your sensitive data with secure storage</p>
<h2 id="synopsis"><span class="header-section-number">5.2</span> SYNOPSIS</h2>
<p><em>akt</em> [ -v ] [-vv] [-vv] [-V] [ -c <em>config-file</em> ] [-t <em>count</em> ] [-z] <em>command</em> [-k <em>file</em> ] [ -d <em>dir</em> ] [ -p <em>password</em> ] [–password <em>password</em> ] [–passfile <em>file</em> ] [–passenv <em>name</em> ] [–passfd <em>fd</em> ] [–passask] [–passcmd <em>cmd</em> ] [–passkey <em>name</em> ] [–wallet-key-file <em>file</em> ] [–wallet-key <em>name</em> ]</p>
<h2 id="description"><span class="header-section-number">5.3</span> DESCRIPTION</h2>
<p><strong>akt</strong> is a tool to store information in secure wallets and protect the stored information by encrypting the content. It is necessary to know one of the wallet password to access its content. <strong>akt</strong> can be used to safely store passwords, credentials, bank accounts and even documents.</p>
<p>Wallets are protected by a master key using AES-256 and the wallet master key is protected by a user password. The wallet defines up to 7 slots that identify a password key that is able to unlock the master key. To open a wallet, it is necessary to unlock one of these 7 slots by providing the correct password. Wallet key slots are protected by the user’s password and the PBKDF2-HMAC-256 algorithm, a random salt, a random counter and they are encrypted using AES-256.</p>
<p>Values stored in the wallet are protected by their own encryption keys using AES-256. A wallet can contain another wallet which is then protected by its own encryption keys and passwords (with 7 independent slots). Because the child wallet has its own master key, it is necessary to known the primary password and the child password to unlock the parent wallet first and then the child wallet.</p>
<p>The data is organized in blocks of 4K whose primary content is encrypted either by the wallet master key or by the entry keys. The data block is signed by using HMAC-256. A data block can contain several values but each of them is protected by its own encryption key. Each value is also signed using HMAC-256. Large values can be written to several data blocks and in that case each fragment is encrypted by using its own encryption key.</p>
<p>The tool provides several commands that allow to create a keystore, insert values, retrieve values or delete them. You can use it to store your passwords, your secret keys and even your documents.</p>
<p>Passwords are retrieved using one of the following options:</p>
<ul>
<li><p>by reading a file that contains the password,</p></li>
<li><p>by looking at an environment variable,</p></li>
<li><p>by using a command line argument,</p></li>
<li><p>by getting the password through the <strong>ssh-askpass</strong>(1) external command,</p></li>
<li><p>by running an external command,</p></li>
<li><p>by asking interactively the user for the password,</p></li>
<li><p>by asking through a network socket for the password.</p></li>
</ul>
<h2 id="options"><span class="header-section-number">5.4</span> OPTIONS</h2>
<p>The following options are recognized by <strong>akt</strong>:</p>
<p>-V Prints the <em>akt</em> version.</p>
<p>-v Enable the verbose mode.</p>
<p>-vv Enable debugging output.</p>
<p>-c <em>config-file</em> Defines the path of the global <em>akt</em> configuration file.</p>
<p>-t <em>count</em> Defines the number of threads for the encryption and decryption process. By default, it uses the number of system CPU cores.</p>
<p>-k file</p>
<p>Specifies the path of the keystore file to open.</p>
<p>-d directory</p>
<p>Specifies the directory path of the keystore data files. When this option is used, the data blocks are written in separate files. The data blocks do not contain the encryption keys and each of them is encrypted with its own secure key.</p>
<p>-p password</p>
<p>The keystore password is passed within the command line. Using this method is convenient but is not safe.</p>
<p>–passenv envname</p>
<p>The keystore password is passed within an environment variable with the given name. Using this method is considered safer but still provides some security leaks.</p>
<p>–passfile path</p>
<p>The keystore password is passed within a file that is read. The file must not be readable or writable by other users or group: its mode must be r??——. The directory that contains the file must also satisfy the not readable by other users or group members, This method is safer and provides the same security level as the <em>–passkey</em> option.</p>
<p>–passfd fd</p>
<p>The keystore password is passed within a pipe whose file descriptor number is given. The file descriptor is read to obtain the password. This method is safer.</p>
<p>–passask</p>
<p>The keystore password is retrieved by the running the external tool <strong>ssh-askpass</strong>(1) which will ask the password through either KDE, Gnome or another desktop interactive application. The password is retrieved through a pipe that <em>akt</em> sets while launching the command.</p>
<p>–passcmd cmd</p>
<p>The keystore password is retrieved by the running the external command defined in <strong>cmd</strong>. The command should print the password on its standard output without end of line. The password is retrieved through a pipe that <em>akt</em> sets while launching the command.</p>
<p>–passkey name</p>
<p>The keystore password is retrieved from a keyfile with the given basename. The keyfile is created by the <em>genkey</em> command and they are stored on the file system in a specific directory. Unlike the <em>–passfile</em> option, only the basename of the file is given to the option and this avoid to give a full path name in some cases. This provides the same security level as the <em>–passfile</em> option.</p>
<p>–wallet-key-file file Defines the path of a file which contains the wallet master key file.</p>
<p>–wallet-key name Defines the name of the key file which contains the wallet master key.</p>
<p>-z Erase and fill with zeros instead of random values.</p>
<h2 id="commands"><span class="header-section-number">5.5</span> COMMANDS</h2>
<h3 id="the-create-command"><span class="header-section-number">5.5.1</span> The create command</h3>
<pre><code>akt create keystore.akt [--force] [--counter-range min:max] [--split count] [--gpg user ...]</code></pre>
<p>Create a new keystore and protect it with the password. When the keystore file already exist, the create operation will fail unless the <em>–force</em> option is passed.</p>
<p>The password to protect the wallet is passed using one of the following options: <em>–passfile</em>, <em>–passkey</em>, <em>–passenv</em>, <em>–password</em>, <em>–passsocket</em> or <em>–gpg</em>. When none of these options are passed, the password is asked interactively.</p>
<p>The <em>–counter-range</em> option allows to control the range for the random counter used by PBKDF2 to generate the encryption key derived from the specified password. High values provide a strongest derived key at the expense of speed. This option is ignored when the <em>–gpg</em> option is used.</p>
<p>The <em>–split</em> option indicates to use several separate files for the data blocks and it controls the number of separate files to use. When used, a directory with the name of the keystore file is created and will contain the data files.</p>
<p>The <em>–gpg</em> option allows to protect the keystore by using a user’s GPG encryption key. The option argument defines the GPG user’s name or GPG key. When the keystore password is protected by the user’s GPG key, a random password is generated to protect the keystore. The <strong>gpg2</strong>(1) command is used to encrypt that password using the user’s public key and save it in the keystore header. The <strong>gpg2</strong>(1) command is then used to decrypt that and be able to unlock the keystore provided that the user’s private key is known. When using the <em>–gpg</em> option, it is possible to protect the keystore for several users, thus being able to share the secure file with each of them.</p>
<h3 id="the-extract-command"><span class="header-section-number">5.5.2</span> The extract command</h3>
<pre><code>akt extract keystore.akt -- name</code></pre>
<pre><code>akt extract keystore.akt {name...}</code></pre>
<p>This command allows to extract files or directories recursively from the keystore. It is possible to extract several files and directories at the same time.</p>
<p>When the <em>–</em> option is passed, the command accepts only one argument. It extracts the specified name and writes the result on the standard output. It can be used as a target for a pipe command.</p>
<h3 id="the-genkey-command"><span class="header-section-number">5.5.3</span> The genkey command</h3>
<pre><code>akt genkey [--remove] name</code></pre>
<p>The <em>genkey</em> command is used to generate or remove a password key file stored in some safe location on the file system (see the <em>keys</em> configuration variable). The password key file can then be used with the <em>–passkey</em> option. It provides the same security level as using the <em>–passfile</em> option but helps in setting up and using separate key files for different wallets.</p>
<h3 id="the-mount-command"><span class="header-section-number">5.5.4</span> The mount command</h3>
<pre><code>akt mount keystore.akt [-f] [--enable-cache] mount-point</code></pre>
<p>This command is available when the <strong>fuse</strong>(8) support is enabled. It allows to mount the keystore content on the <em>mount-point</em> directory and access the encrypted content through the filesystem. The <em>akt</em> tool works as a daemon to serve <strong>fuse</strong>(8) requests that come from the kernel. The <em>-f</em> option allows to run this daemon as a foreground process. By default, the kernel cache are disabled because the keystore content is decrypted and given as clear content to the kernel. This could be a security issue for some system and users. The kernel cache can be enabled by using the <em>–enable-cache</em> option.</p>
<p>To unmount the file system, one must use the <strong>mount</strong>(8) command.</p>
<pre><code>umount mount-point</code></pre>
<h3 id="the-set-command"><span class="header-section-number">5.5.5</span> The set command</h3>
<pre><code>akt set keystore.akt name value</code></pre>
<p>The <em>set</em> command is used to store a content passed as command line argument in the wallet. If the wallet already contains the name, the value is updated.</p>
<h3 id="the-store-command"><span class="header-section-number">5.5.6</span> The store command</h3>
<pre><code>akt store keystore.akt -- name</code></pre>
<pre><code>akt store keystore.akt {file...|directory...}</code></pre>
<p>This command can store files or directories recursively in the keystore. It is possible to store several files and directories at the same time.</p>
<p>When the <em>–</em> option is passed, the command accepts only one argument. It reads the standard input and stores it under the specified name. It can be used as a target for a pipe command.</p>
<h3 id="the-remove-command"><span class="header-section-number">5.5.7</span> The remove command</h3>
<pre><code>akt remove keystore.akt name ...</code></pre>
<p>The <em>remove</em> command is used to erase a content from the wallet. The data block that contained the content to protect is erased and replaced by zeros. The secure key that protected the wallet entry is also cleared. It is possible to remove several contents.</p>
<h3 id="the-edit-command"><span class="header-section-number">5.5.8</span> The edit command</h3>
<pre><code>akt edit keystore.akt [-e editor] name</code></pre>
<p>The <em>edit</em> command can be used to edit the protected wallet entry by calling the user’s prefered editor with the content. The content is saved in a temporary directory and in a temporary file. The editor is launched with the path and when editing is finished the temporary file is read. The temporary directory and files are erased when the editor terminates successfully or not. The editor can be specified by using the <em>-e</em> option, by setting up the <em>EDITOR</em> environment variable or by updating the <strong>editor</strong>(1) alternative with <strong>update-alternative</strong>(1).</p>
<h3 id="the-list-command"><span class="header-section-number">5.5.9</span> The list command</h3>
<pre><code>akt list keystore.akt</code></pre>
<p>The <em>list</em> command describes the entries stored in the keystore with their name, size, type, creation date and number of keys which protect the entry.</p>
<h3 id="the-get-command"><span class="header-section-number">5.5.10</span> The get command</h3>
<pre><code>akt get keystore.akt [-n] name...</code></pre>
<p>The <em>get</em> command allows to retrieve the value associated with a wallet entry. It retrieves the value for each name passed to the command. The value is printed on the standard output. By default a newline is emitted after each value. The <em>-n</em> option prevents the output of the trailing newline.</p>
<h3 id="the-otp-command"><span class="header-section-number">5.5.11</span> The otp command</h3>
<pre><code>akt \fBotp keystore.akt name

akt \fBotp keystore.akt otpauth://totp/account?secret=secret&amp;issuer=issuer</code></pre>
<p>The <em>otp</em> command manages OATH secrets and provides TOTP code generation for a two factor authentication. When an otpauth://totp/ string is given, the account is extracted and it is inserted in the wallet. When an account name or issuer name is given, the command uses the secret to generate the 6 digit codes for the authentication. When no parameter are given the command gives a list of known otpauth URI.</p>
<h3 id="the-password-add-command"><span class="header-section-number">5.5.12</span> The password-add command</h3>
<pre><code>akt password-add keystore.akt [--new-passfile file] [--new-password password] [--new-passenv name]</code></pre>
<p>The <em>password-add</em> command allows to add a new password in one of the wallet key slot. Up to seven passwords can be defined to protect the wallet. The overall security of the wallet is that of the weakest password. To add a new password, one must know an existing password.</p>
<h3 id="the-password-remove-command"><span class="header-section-number">5.5.13</span> The password-remove command</h3>
<pre><code>akt password-remove keystore.akt [--force]</code></pre>
<p>The <em>password-remove</em> command can be used to erase a password from the wallet master key slots. Removing the last password makes the keystore unusable and it is necessary to pass the <em>–force</em> option for that.</p>
<h3 id="the-password-set-command"><span class="header-section-number">5.5.14</span> The password-set command</h3>
<pre><code>akt password-set [--new-passfile file] [--new-password password] [--new-passenv name]</code></pre>
<p>The <em>password-set</em> command allows to change the current wallet password.</p>
<h2 id="security"><span class="header-section-number">5.6</span> SECURITY</h2>
<p>Wallet master keys are protected by a derived key that is created from the user’s password using <em>PBKDF2</em> and <em>HMAC-256</em> as hashing operation. When the wallet is first created, a random salt and counter are allocated which are then used by the <em>PBKDF2</em> generation. The wallet can be protected by up to 7 different passwords. Despite this, the security of the wallet master key still depends on the strength of the user’s password. For this matter, it is still critical for the security to use long passphrases.</p>
<p>The passphrase can be passed within an environment variable or within a command line argument. These two methods are considered unsafe because it could be possible for other processes to see these values. It is best to use another method such as using the interactive form, passing the password through a file or passing using a socket based communication.</p>
<p>When the wallet master key is protected using <strong>gpg2</strong>(1) a 32-bytes random binary key and a 16-bytes random binary IV is created to protect the wallet master key. Another set of 80 bytes of random binary data is used to encrypt and sign the whole wallet master key block. The 128 bytes that form these random binary keys are encrypted using the user’s GPG public key and the result saved in the keystore header block. The <em>–gpg</em> option is specified only for the creation of the keystore and allows to encrypt a master key slot for several GPG keys. To unlock the keystore file, the <strong>gpg2</strong>(1) command will be used to decrypt the keystore header content automatically. When the user’s GPG private key is not found, it is not possible to unlock the keystore with this method.</p>
<p>When several GPG keys are used to protect the wallet, they share the same 80 bytes to decrypt the wallet master key block but they have their own key and IV to unlock the key slot.</p>
<p>Depending on the size, a data stored in the wallet is split in one or several data entry. Each wallet data entry is then protected by their own secret key and IV vector. Wallet data entry are encrypted using AES-256-CBC. The wallet data entry key and IV vectors are protected by the wallet master key.</p>
<p>When the <em>–split</em> option is used, the data storage files only contain the data blocks. They do not contain any encryption key. The data storage files use the <em>.dkt</em> file extension.</p>
<h2 id="configuration-1"><span class="header-section-number">5.7</span> CONFIGURATION</h2>
<p>The <em>akt</em> global configuration file contains several configuration properties which are used to customize several commands. These properties can be modified with the <em>config</em> command.</p>
<h3 id="gpg-encrypt"><span class="header-section-number">5.7.1</span> gpg-encrypt</h3>
<p>This property defines the <strong>gpg2</strong>(1) command to be used to encrypt a content. The content to encrypt is passed in the standard input and the encrypted content is read from the standard output. The GPG key parameter can be retrieved by using the <em>$USER</em> pattern.</p>
<h3 id="gpg-decrypt"><span class="header-section-number">5.7.2</span> gpg-decrypt</h3>
<p>This property defines the <strong>gpg2</strong>(1) command to be used to decrypt a content. The content to decrypt is passed in the standard input and the decrypted content is read from the standard output.</p>
<h3 id="gpg-list-keys"><span class="header-section-number">5.7.3</span> gpg-list-keys</h3>
<p>This property defines the <strong>gpg2</strong>(1) command to be used to retrieve the list of available secret keys. This command is executed when the keystore file is protected by a GPG key to identify the possible GPG Key ids that are capable of decrypting it.</p>
<h3 id="keys"><span class="header-section-number">5.7.4</span> keys</h3>
<p>This property defines the directory path where the key files generated by the <em>genkey</em> and specified with the <em>–passkey</em> option are stored. The default location is the <em>$HOME/.config/akt/keys</em> directory.</p>
<h3 id="fill-zero"><span class="header-section-number">5.7.5</span> fill-zero</h3>
<p>This property controls whether <em>akt</em> must fill unused data areas with zeros or with random bytes.</p>
<h2 id="see-also"><span class="header-section-number">5.8</span> SEE ALSO</h2>
<p><strong>editor(1)</strong>, <strong>update-alternative(1)</strong>, <strong>ssh-askpass(1)</strong>, <strong>gpg2(1)</strong>, <strong>mount(8)</strong>, <strong>fuse(8)</strong></p>
<h2 id="author"><span class="header-section-number">5.9</span> AUTHOR</h2>
<p>Written by Stephane Carrez.</p>

<h1 id="implementation"><span class="header-section-number">6</span> Implementation</h1>
<p>This chapter explains how the wallets are organised and protected.</p>
<h2 id="file-layouts"><span class="header-section-number">6.1</span> File layouts</h2>
<p>The data is organized in 4K blocks. The first block is a header block used to store various information to identify the storage files. Other blocks have a clear 16-byte header and an HMAC-256 signature at the end. Blocks are encrypted either by using the master key, the directory key, the data key or a per-data fragment key.</p>
<figure>
<img src="images/akt-keystore-blocks.png" alt="Keystore blocks overview" /><figcaption>Keystore blocks overview</figcaption>
</figure>
<p>The master key block and directory block are the two blocks that contain encryption keys.</p>
<h3 id="header-block"><span class="header-section-number">6.1.1</span> Header block</h3>
<p>The first block of the file is the keystore header block which contains clear information signed by an HMAC header. The header block contains the keystore UUID as well as a short description of each storage data file. It also contains some optional header data.</p>
<pre><code>+------------------+
| 41 64 61 00      | 4b = Ada
| 00 9A 72 57      | 4b = 10/12/1815
| 01 9D B1 AC      | 4b = 27/11/1852
| 00 01            | 2b = Version 1
| 00 01            | 2b = File header length in blocks
+------------------+
| Keystore UUID    | 16b
| Storage ID       | 4b
| Block size       | 4b
| Storage count    | 4b
| Header Data count| 2b
+------------------+-----
| Header Data size | 2b
| Header Data type | 2b = 0 (NONE), 1 (GPG1) 2, (GPG2)
+------------------+
| Header Data      | Nb
+------------------+-----
| ...              |
+------------------+-----
| 0                |
+------------------+-----
| ...              |
+------------------+-----
| Storage ID       | 4b
| Storage type     | 2b
| Storage status   | 2b  00 = open, Ada = sealed
| Storage max bloc | 4b
| Storage HMAC     | 32b = 44b
+------------------+----
| Header HMAC-256  | 32b
+------------------+----</code></pre>
<h3 id="gpg-header-data"><span class="header-section-number">6.1.2</span> GPG Header data</h3>
<p>The GPG encrypted data contains the following information:</p>
<pre><code>+------------------+-----
| TAG              | 4b
+------------------+-----
| Lock Key         | 32b
| Lock IV          | 16b
| Wallet Key       | 32b
| Wallet IV        | 16b
| Wallet Sign      | 32b
+------------------+-----</code></pre>
<h3 id="master-keys"><span class="header-section-number">6.1.3</span> Master keys</h3>
<p>Wallet header encrypted with the parent wallet id</p>
<pre><code>+------------------+
| 01 01            | 2b
| Encrypt size     | 2b
| Parent Wallet id | 4b
| PAD 0            | 4b
| PAD 0            | 4b
+------------------+
| Wallet magic     | 4b
| Wallet version   | 4b
| Wallet lid       | 4b
| Wallet block ID  | 4b
+------------------+
| Wallet gid       | 16b
+------------------+
| Wallet key count | 4b
| PAD 0            | 4b
+------------------+
| Key type         | 4b
| Key size         | 4b
| Counter for key  | 4b
| Counter for iv   | 4b
| Salt for key     | 32b
| Salt for iv      | 32b
| Key slot sign    | 32b
| Dir key # 1      | 32b ---
| Dir iv # 1       | 16b  ^
| Dir sign # 1     | 32b  |
| Data key # 1     | 32b  |
| Data iv # 1      | 16b  | Encrypted by user&#39;s password
| Data sign #1     | 32b  |
| Key key # 1      | 32b  |
| Key iv # 1       | 16b  v
| Key sign #1      | 32b ---
| Slot HMAC-256    | 32b
| PAD 0 / Random   | 80b
+------------------+
| Key slot #2      | 512b
+------------------+
| Key slot #3      | 512b
+------------------+
| Key slot #4      | 512b
+------------------+
| Key slot #5      | 512b
+------------------+
| Key slot #6      | 512b
+------------------+
| Key slot #7      | 512b
+------------------+
| PAD 0 / Random   |
+------------------+
| Block HMAC-256   | 32b
+------------------+</code></pre>
<h3 id="directory-entries"><span class="header-section-number">6.1.4</span> Directory Entries</h3>
<p>The wallet repository block is encrypted with the wallet directory key.</p>
<pre><code>+------------------+
| 02 02            | 2b
| Encrypt size     | 2b = BT_DATA_LENGTH
| Wallet id        | 4b
| PAD 0            | 4b
| PAD 0            | 4b
+------------------+
| Next block ID    | 4b  Block number for next repository block with same storage
| Data key offset  | 2b  Starts at IO.Block_Index&#39;Last, decreasing
+------------------+
| Entry ID         | 4b   ^
| Entry type       | 2b   | = T_STRING, T_BINARY
| Name size        | 2b   |
| Name             | Nb   | DATA_NAME_ENTRY_SIZE + Name&#39;Length
| Create date      | 8b   |
| Update date      | 8b   |
| Entry size       | 8b   v
+------------------+
| Entry ID         | 4b   ^
| Entry type       | 2b   | = T_WALLET
| Name size        | 2b   |
| Name             | Nb   | DATA_NAME_ENTRY_SIZE + Name&#39;Length
| Create date      | 8b   |
| Update date      | 8b   |
| Wallet lid       | 4b   |
| Wallet master ID | 4b   v
+------------------+
| ...              |
+------------------+--
| 0 0 0 0          | 4b (End of name entry list = DATA_KEY_SEPARATOR)
+------------------+--
| ...              |     (random or zero)
+------------------+--  &lt;- = Data key offset
| ...              |
+------------------+
| Storage ID       | 4b   ^ Repeats &quot;Data key count&quot; times
| Data block ID    | 4b   |
| Data size        | 2b   | DATA_KEY_ENTRY_SIZE = 58b
| Content IV       | 16b  |
| Content key      | 32b  v
+------------------+
| Entry ID         | 4b   ^
| Data key count   | 2b   | DATA_KEY_HEADER_SIZE = 10b
| Data offset      | 4b   v
+------------------+
| Block HMAC-256   | 32b
+------------------+--</code></pre>
<h3 id="data-block"><span class="header-section-number">6.1.5</span> Data Block</h3>
<p>Data block start is encrypted with wallet data key, data fragments are encrypted with their own key. Loading and saving data blocks occurs exclusively from the workers package. The data block can be stored in a separate file so that the wallet repository and its keys are separate from the data blocks.</p>
<pre><code>+------------------+
| 03 03            | 2b
| Encrypt size     | 2b = DATA_ENTRY_SIZE * Nb data fragment
| Wallet id        | 4b
| PAD 0            | 4b
| PAD 0            | 4b
+------------------+-----
| Entry ID         | 4b  Encrypted with wallet id
| Slot size        | 2b
| 0 0              | 2b
| Data offset      | 8b
| Content HMAC-256 | 32b =&gt; 48b = DATA_ENTRY_SIZE
+------------------+
| ...              |
+------------------+-----
| ...              |
+------------------+
| Data content     |     Encrypted with data entry key
+------------------+-----
| Block HMAC-256   | 32b
+------------------+</code></pre>
<h2 id="keystore-protections"><span class="header-section-number">6.2</span> Keystore Protections</h2>
<p>The master key block contains the primary keys that are used to encrypt other blocks. The master key block contains 7 key slots that are capable to unlock the master keys. Each slot is independent and can be associated with a specific authentication method. Two authentication methods are supported:</p>
<ul>
<li>password based authentication,</li>
<li>GPG based authentication.</li>
</ul>
<h3 id="password-protection"><span class="header-section-number">6.2.1</span> Password Protection</h3>
<p>In this mode, three secret information must be provided:</p>
<ul>
<li>the wallet header key and IV,</li>
<li>the wallet signature key,</li>
<li>the user password.</li>
</ul>
<p>First, the wallet master key block is decrypted with AES-256-CBC by using the wallet header key and IV. The HMAC-256 signature is then computed with the wallet signature key on the decrypted content and the clear 16-byte header at beginning of the block. The HMAC signature must match the signature found at end of the block.</p>
<p>Once the wallet master key block is decrypted, the user password is checked against the available key slots. For a given password protected key slot, a derived key is generated by using the PBKDF2-HMAC256 algorithm. First, a 16-byte IV is generated and then a 32-byte key is generated. For each PBKDF2 execution a specific 32-byte salt and counter is used. The key slot is then decrypted by using the derived keys with AES-256-CBC. An HMAC-256 signature is built to verify the decrypted content. When the HMAC signature matches the signature found in the key slot, the provided user’s password is valid.</p>
<figure>
<img src="images/akt-keystore-keys.png" alt="Password based protection" /><figcaption>Password based protection</figcaption>
</figure>
<h3 id="gpg-protection"><span class="header-section-number">6.2.2</span> GPG Protection</h3>
<p>With the GPG protection, the header block contains additional information that is decrypted with the user’s GPG private key. When such additional data is successfully decrypted, it contains several parts:</p>
<ul>
<li>the wallet header key and IV,</li>
<li>the wallet signature key,</li>
<li>the key slot encryption key and IV.</li>
</ul>
<p>The wallet master key block is decrypted and validated using the same process as the password protection.</p>
<p>The key slot that matches the GPG key is identified by a header tag that is found in the key slot and in the GPG header data. The key slot is decrypted by using the key slot encryption key and IV that was decrypted by GPG. It is validated using HMAC-256.</p>
<figure>
<img src="images/akt-keystore-keys-gpg.png" alt="GPG based protection" /><figcaption>GPG based protection</figcaption>
</figure>
<h3 id="directory-protection"><span class="header-section-number">6.2.3</span> Directory Protection</h3>
<p>A directory block contains the name of contents found in the keystore as well as the keys used to encrypt data fragments. The directory block is decrypted with AES-256-CBC by using the directory key and IV. The directory block number is xored on the directory IV to obtain the IV used for the decryption. An HMAC-256 signature is computed with the clear 16-byte header and the decrypted directory content. It is then verified against the block HMAC.</p>
<p>Once decrypted, the directory block contains two areas. At beginning of the block, it contains the entry names that are stored in the keystore. For each entry, a unique entry ID is assigned and is used as a unique reference.</p>
<p>At end of the block, it contains the encryption keys and the block numbers where the data fragments are stored. Each data fragment has its own encryption key and IV.</p>
<figure>
<img src="images/akt-keystore-directory.png" alt="Directory protection" /><figcaption>Directory protection</figcaption>
</figure>
